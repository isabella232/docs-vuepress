(window.webpackJsonp=window.webpackJsonp||[]).push([[287],{400:function(e,t,a){"use strict";a.r(t);var s=a(0),n=Object(s.a)({},function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"developing-a-custom-rundeck-script-plugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#developing-a-custom-rundeck-script-plugin","aria-hidden":"true"}},[e._v("#")]),e._v(" Developing a custom Rundeck script plugin")]),e._v(" "),a("p",[e._v("In this tutorial we'll learn:")]),e._v(" "),a("ul",[a("li",[e._v("Why you might benefit from a custom Rundeck script plugin")]),e._v(" "),a("li",[e._v("How to create a basic script plugin")]),e._v(" "),a("li",[e._v("How to deploy the necessary Rundeck configuration to use it")])]),e._v(" "),a("p",[e._v("The end result of this tutorial as well as a Docker environment to run it in can be found on "),a("a",{attrs:{href:"https://github.com/clofresh/rundeck-playground",target:"_blank",rel:"noopener noreferrer"}},[e._v("GitHub"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"why-create-your-own-script-plugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#why-create-your-own-script-plugin","aria-hidden":"true"}},[e._v("#")]),e._v(" Why create your own script plugin?")]),e._v(" "),a("p",[e._v("Rundeck is an open source ops automation platform that comes with a lot of functionality out of the box, like running script commands on your nodes with a command step. If you can already run commands with the default functionality, why would you want to write a new plugin to do that?")]),e._v(" "),a("p",[e._v("Several reasons:")]),e._v(" "),a("ul",[a("li",[e._v("To encapsulate and reuse functionality across projects and jobs")]),e._v(" "),a("li",[e._v("To expose script parameters to the UI with descriptions, types and defaults")]),e._v(" "),a("li",[e._v("To securely access secrets stored in Key Storage")])]),e._v(" "),a("h3",{attrs:{id:"encapsulate-and-reuse-functionality-across-projects-and-jobs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#encapsulate-and-reuse-functionality-across-projects-and-jobs","aria-hidden":"true"}},[e._v("#")]),e._v(" Encapsulate and reuse functionality across projects and jobs")]),e._v(" "),a("p",[e._v("Command defined as a command step are specific to a job. If you need to reuse the script in several jobs in the same or different projects, you would have to copy-paste it each time which can get to be cumbersome and error-prone.")]),e._v(" "),a("p",[e._v("Using a custom plugin encapsulates the script so that job writers across any projects can use the script's functionality. When the plugin author uploads a new version the plugin, all jobs automatically use the latest version.")]),e._v(" "),a("h3",{attrs:{id:"expose-script-parameters-to-the-ui-with-descriptions-types-and-defaults"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expose-script-parameters-to-the-ui-with-descriptions-types-and-defaults","aria-hidden":"true"}},[e._v("#")]),e._v(" Expose script parameters to the UI with descriptions, types and defaults")]),e._v(" "),a("p",[e._v("Command line scripts can come with many parameters. When running them from command line, if you're lucky, you are able to get the help text from them. Some scripts may not have help on their parameters. When creating a custom script plugin, you can define, document and provide default values that make sense in the context of your organization for the parameters of your script. Conversely, you can also leave out parameters to a script that you don't want job authors to have access to.")]),e._v(" "),a("p",[e._v("All the parameters defined in the plugin will show up in the Rundeck job editting UI, providing the job authors with afforances to guide them in using the script.")]),e._v(" "),a("h3",{attrs:{id:"securely-access-secrets-stored-in-key-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#securely-access-secrets-stored-in-key-storage","aria-hidden":"true"}},[e._v("#")]),e._v(" Securely access secrets stored in Key Storage")]),e._v(" "),a("p",[e._v("Many scripts require some type of secret to authorize the script to do its work so the job user needs to know the secret to use the script. This increases the risk of that secret getting exposed depending how your share secrets in your organization.")]),e._v(" "),a("p",[e._v("A more secure solution would be to authorize the job user to use the secret without them actually know its value. Plugins can access secrets by referring to paths in the Rundeck Key Storage. Rundeck will evaluate the value of the secret into the execution without the job user ever knowing the value. This reduces the scope of who needs to know the secret to the Rundeck administrator populating the Key Storage. It also lets the administrator rotate the secrets transparent to the job user.")]),e._v(" "),a("h2",{attrs:{id:"how-to-create-a-simple-workflow-step-script-plugin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-create-a-simple-workflow-step-script-plugin","aria-hidden":"true"}},[e._v("#")]),e._v(" How to create a simple workflow step script plugin")]),e._v(" "),a("p",[e._v("Now that we see the value in creating our own workflow step script plugin, we can walk through a simple Hello World example.")]),e._v(" "),a("h3",{attrs:{id:"script-to-wrap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#script-to-wrap","aria-hidden":"true"}},[e._v("#")]),e._v(" Script to wrap")]),e._v(" "),a("p",[e._v("We're going to wrap a simple bash script called helloworld.sh:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[e._v("#!/bin/bash")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Hello world from '),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("hostname")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("! I am a "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$1")]),e._v(". Don't tell anyone that the secret is "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[e._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$2")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[e._v('\\"')]),e._v('"')]),e._v("\n")])])]),a("p",[e._v("It prints the hostname it's called on and the first and second parameters passed to it. We can wrap a script from any scripting language as long as the intepreter is already deployed on the remote nodes.")]),e._v(" "),a("h3",{attrs:{id:"basic-plugin-structure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-plugin-structure","aria-hidden":"true"}},[e._v("#")]),e._v(" Basic plugin structure")]),e._v(" "),a("p",[e._v("A Rundeck plugin is a zipped directory with the following structure:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("helloworld-plugin.zip\nhelloworld-plugin      -- root directory of zip contents, same name as zip file\n├── plugin.yaml        -- plugin metadata file\n└── contents           -- where to put your scripts\n    └── helloworld.sh\n")])])]),a("p",[a("code",[e._v("plugin.yaml")]),e._v(" is the only required file in the zip. This is the "),a("code",[e._v("plugin.yaml")]),e._v(" for our Hello World plugin:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Hello World\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("rundeckPluginVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1.2")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("author")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Carlo Cabanilla\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token datetime number"}},[e._v("2018-07-20")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("//rundeck.org/\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("providers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" HelloBash\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("service")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" RemoteScriptNodeStep\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("plugin-type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" script\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("script-interpreter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" /bin/bash\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("script-file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" helloworld.sh\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("script-args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("config.who_i_am"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("config.secret_secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" who_i_am\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Select\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("title")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Who I Am\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Provide a predefined list of options\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" machine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" mannequin\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" machine\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" secret_secret\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" String\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("title")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" My Secret\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Securely pass this to the script\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("renderingOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("valueConversion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"STORAGE_PATH_AUTOMATIC_READ"')]),e._v("\n")])])]),a("p",[e._v("The significant section is the item in the "),a("code",[e._v("providers")]),e._v(" array. It says we're creating a RemoteScriptNodeStep named HelloBash. A RemoteScriptNodeStep means the script will run on the remote nodes, as opposed to a WorkflowNodeStep, which runs on the Rundeck server itself and receives the nodes as parameters.")]),e._v(" "),a("h4",{attrs:{id:"script-invokation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#script-invokation","aria-hidden":"true"}},[e._v("#")]),e._v(" Script invokation")]),e._v(" "),a("p",[e._v("The values for "),a("code",[e._v("script-interpreter")]),e._v(", "),a("code",[e._v("script-file")]),e._v(", and "),a("code",[e._v("script-args")]),e._v(" are invoked on the remote node as follows:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("/bin/bash helloworld.sh "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${job.name}")]),e._v("\n")])])]),a("p",[a("code",[e._v("helloworld.sh")]),e._v(" only needs to be bundled in the plugin zip contents directory and Rundeck takes care of copying it to the remote nodes that it runs on.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("script-args")]),e._v(" value we pass to the script, "),a("code",[e._v("${job.name}")]),e._v(" is one of many context variables that Rundeck sets.")]),e._v(" "),a("h4",{attrs:{id:"script-parameters"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#script-parameters","aria-hidden":"true"}},[e._v("#")]),e._v(" Script parameters")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("config")]),e._v(" key defines the inputs to the script, their types, defaults and how they're rendered in the UI.")]),e._v(" "),a("p",[e._v("The "),a("code",[e._v("who_i_am")]),e._v(" item describes a select box with predefined values of "),a("code",[e._v("machine")]),e._v(" or "),a("code",[e._v("mannequin")]),e._v(", defaulting to "),a("code",[e._v("machine")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" who_i_am\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Select\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("title")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Who I Am\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Provide a predefined list of options\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" machine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" mannequin\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" machine\n")])])]),a("p",[e._v("The "),a("code",[e._v("secret_secret")]),e._v(" item is a string value but the "),a("code",[e._v('valueConversion: "STORAGE_PATH_AUTOMATIC_READ"')]),e._v(" tells Rundeck to interpret that string as a path in Key Storage and pass the value of that key to the script. This is how we can securely reference secrets without exposing them to the job users.")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" secret_secret\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" String\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("title")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" My Secret\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Securely pass this to the script\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("renderingOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("valueConversion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"STORAGE_PATH_AUTOMATIC_READ"')]),e._v("\n")])])]),a("h3",{attrs:{id:"setting-up-the-plugin-environment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#setting-up-the-plugin-environment","aria-hidden":"true"}},[e._v("#")]),e._v(" Setting up the plugin environment")]),e._v(" "),a("p",[e._v("How can we actually see this plugin in action? Rundeck is designed for real world multi-node environments but we don't want the hassle of actually spinning one up, so we use Docker to simulate a multi-node environment right on our workstation.")]),e._v(" "),a("p",[e._v("The environment setup can be downloaded at "),a("a",{attrs:{href:"https://github.com/clofresh/rundeck-playground",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/clofresh/rundeck-playground"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("To build and start the Docker environment, run:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v(" compose\n")])])]),a("p",[e._v("This make command is specific to this tutorial. It will do several things:")]),e._v(" "),a("ol",[a("li",[e._v("Zip the plugin source files into the proper zip structure and save it in the Rundeck image's build directory")]),e._v(" "),a("li",[e._v("Run Docker Compose to build all the images specified in "),a("code",[e._v("docker-compose.yml")]),e._v(" and run containers from those images. Docker Compose will run the containers in the foreground, outputting all their logs to your terminal.")])]),e._v(" "),a("p",[e._v("The containers in our environment are:")]),e._v(" "),a("ul",[a("li",[e._v("rundeck: The Rundeck server. The Dockerfile copies the zipped plugin into the image's "),a("code",[e._v("libext")]),e._v(" directory where Rundeck will watch for new plugins.")]),e._v(" "),a("li",[e._v("rundeck-cli: The Rundeck command line client. This image doesn't run as a service but instead we invoke it from command line to push configuration and invoke jobs on the Rundeck server.")]),e._v(" "),a("li",[e._v("web_1 & web_2: Containers that simulate your application nodes. They run both an ssh daemon and a sample web app. These are the nodes that Rundeck will execute our plugin on.")])]),e._v(" "),a("h3",{attrs:{id:"pushing-configuration-to-rundeck"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pushing-configuration-to-rundeck","aria-hidden":"true"}},[e._v("#")]),e._v(" Pushing configuration to Rundeck")]),e._v(" "),a("p",[e._v("Once our Docker environment is up and the Rundeck server is listening for requests, we can push a sample project and job that will use our plugin. We do that from a separate terminal that our "),a("code",[e._v("make compose")]),e._v(" command:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v(" rd-config\n")])])]),a("p",[e._v("This will:")]),e._v(" "),a("ul",[a("li",[e._v("Check for changes in our plugin source files, and if so, copy a new plugin zip into the running Rundeck container.")]),e._v(" "),a("li",[e._v("Push all the Rundeck yaml config in "),a("code",[e._v("rundeck-project")]),e._v(" to the running Rundeck server.")]),e._v(" "),a("li",[e._v("Push the keys in "),a("code",[e._v("rundeck-project/key-storage")]),e._v(" to the Key Storage.")])]),e._v(" "),a("p",[e._v("With this command, you can iterate on your plugin or job configuration without having to stop and start the Docker environment. Additionally, it will only push config that has changed.")]),e._v(" "),a("p",[e._v("The configuration we're pushing defines the nodes, project and job that use our plugin.")]),e._v(" "),a("p",[e._v("If you just want to run the job, you can skip ahead to "),a("em",[e._v("Running the Hello World job")]),e._v(", otherwise we walk through the config involved in the sections below.")]),e._v(" "),a("h4",{attrs:{id:"nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodes","aria-hidden":"true"}},[e._v("#")]),e._v(" Nodes")]),e._v(" "),a("p",[e._v("In order for Rundeck to know which nodes exist in your environment and how to connect to them, we provide a resource source yaml file:")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("web_1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" web_1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" web\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("web_2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" web_2\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" web\n")])])]),a("h4",{attrs:{id:"project"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project","aria-hidden":"true"}},[e._v("#")]),e._v(" Project")]),e._v(" "),a("p",[e._v("To use the above defined resource source file, we set the following properties on the project:")]),e._v(" "),a("div",{staticClass:"language-properties extra-class"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("project.ssh.user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("root")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("project.ssh-keypath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("/home/rundeck/.ssh/rundeck-playground")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("resources.source.1.config.file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("/home/rundeck/nodes.yaml")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("resources.source.1.config.generateFileAutomatically")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("false")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("resources.source.1.config.includeServerNode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("true")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("resources.source.1.type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[e._v("file")]),e._v("\n")])])]),a("p",[a("code",[e._v("project.ssh.user")]),e._v(" and "),a("code",[e._v("project.ssh-keypath")]),e._v(" configure the ssh user and private key to use when connecting to any node with this project. It's up to you to properly distribute the ssh keys to your nodes. In our playground environment, we've bundled the keys into the Docker images.")]),e._v(" "),a("p",[a("code",[e._v("resources.source.1.config.file")]),e._v(" points to the "),a("code",[e._v("nodes.yaml")]),e._v(" file we created previously.")]),e._v(" "),a("p",[e._v("Both the ssh private key and the "),a("code",[e._v("nodes.yaml")]),e._v(" file need to be deployed to the Rundeck server and be readable by the rundeck user.")]),e._v(" "),a("h4",{attrs:{id:"job"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#job","aria-hidden":"true"}},[e._v("#")]),e._v(" Job")]),e._v(" "),a("p",[e._v("To define our job, we create another yaml file, "),a("code",[e._v("rundeck-project/hello_test_job.yaml")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Hello Test Job\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("description")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"A job to test our hello world plugin"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("nodefilters")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("filter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" web_.*\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("sequence")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("commands")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("nodeStep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[e._v("true")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" HelloBash\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("configuration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("secret_secret")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" keys/projects/hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("project/mysecret\n")])])]),a("p",[e._v("Some values to note:")]),e._v(" "),a("ul",[a("li",[e._v("The "),a("code",[e._v("nodefilters")]),e._v(" key is letting us specify a regex to match the tags of the nodes we want to run this job on. In our case, any of the web nodes.")]),e._v(" "),a("li",[e._v("The "),a("code",[e._v("sequence")]),e._v(" key defines what the job should run. In our case, we're running one command, a node step of our HelloBash script from our custom plugin.")]),e._v(" "),a("li",[e._v("The "),a("code",[e._v("configuration")]),e._v(" key of the node step is how we pass configuration into our script. Note that we're passing in a Key Storage path instead of an actual value.")])]),e._v(" "),a("h3",{attrs:{id:"running-the-hello-world-job"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#running-the-hello-world-job","aria-hidden":"true"}},[e._v("#")]),e._v(" Running the Hello World job")]),e._v(" "),a("p",[e._v("Now that we've spun up a Rundeck environment and defined a job that uses our plugin, we can run it using the "),a("code",[e._v("rd")]),e._v(" command line client. If you had the "),a("code",[e._v("rd")]),e._v(" client installed natively, it would be as simple as:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("RD_PROJECT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("hello-project\nrd run -f --job "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Hello Test Job'")]),e._v("\n")])])]),a("p",[e._v("But since we're running "),a("code",[e._v("rd")]),e._v(" from a Docker container, we need some extra commands to get it to run:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("alias")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("rd")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'docker run --network rundeck-playground_default --mount type=bind,source=\""),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\",target=/root -e RD_PROJECT=hello-project playground-rundeck-cli '")]),e._v("\n\nrd run -f --job "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Hello Test Job'")]),e._v("\n")])])]),a("p",[e._v("The "),a("code",[e._v("rd")]),e._v(" alias we've created lets us type less and use the "),a("code",[e._v("rd")]),e._v(" command as if it were running natively on our workstation.")]),e._v(" "),a("p",[e._v("All this is encapsulated in a make command:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v(" rd-run-job\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Found matching job: 7fd65208-4482-456b-9d76-aa099171938e Hello Test Job")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Execution started: [3] 7fd65208-4482-456b-9d76-aa099171938e /Hello Test Job <http://127.0.0.1:4440/project/hello-project/execution/show/3>")]),e._v("\nHello world from abee114adea5"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v(" Don"),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'t tell anyone that the secret is \"I'")]),e._v("m Kilroy"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"\nHello world from 9964ad40468a! Don\'t tell anyone that the secret is "')]),e._v("I'm Kilroy"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v('"\n')])])]),a("p",[e._v("The script outputs the hostnames it's running on, which will most likely be different but similar to the above, as well as the secret \"I'm Kilroy!\". Remember that we passed in a Key Storage path value "),a("code",[e._v("keys/projects/hello-project/mysecret")]),e._v(" for that parameter. To double check that that's the correct value, you can cat the value on disk that we pushed to the Rundeck server:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("cat")]),e._v(" rundeck-project/key-storage/keys/projects/hello-project/mysecret\nI'm Kilroy"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v("\n")])])]),a("p",[e._v("Another thing to notice is that even though we've securely passed the secret to the script plugin, once the script plugin has it, they can do whatever with the value, including expose it in the logs, so the script writer needs to be cautious about that.")]),e._v(" "),a("h2",{attrs:{id:"next-a-real-world-use-case"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#next-a-real-world-use-case","aria-hidden":"true"}},[e._v("#")]),e._v(" Next: a real world use case")]),e._v(" "),a("p",[e._v("Now that we understand the basics of how a custom script plugin works, we can use it to solve a real world use case: "),a("router-link",{attrs:{to:"/tutorials/custom-script-plugin-db-cred-rotation.html"}},[e._v("rotating database credentials")]),e._v(".")],1)])},[],!1,null,null,null);t.default=n.exports}}]);