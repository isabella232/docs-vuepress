(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{367:function(t,a,s){t.exports=s.p+"assets/img/log-highlight-none.f54d847a.png"},368:function(t,a,s){t.exports=s.p+"assets/img/log-highlight-bold.af6757c1.png"},379:function(t,a,s){"use strict";s.r(a);var e=s(0),n=Object(e.a)({},function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"using-log-filters"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#using-log-filters","aria-hidden":"true"}},[t._v("#")]),t._v(" Using Log Filters")]),t._v(" "),e("p",[t._v("In this tutorial we'll learn how to use Rundeck's log filters to")]),t._v(" "),e("ul",[e("li",[t._v("Capture key value data for use in subsequent jobs")]),t._v(" "),e("li",[t._v("Highlight important output to improve job output readability")]),t._v(" "),e("li",[t._v("Suppress potentially sensitive information from leaking into the logs")])]),t._v(" "),e("h2",{attrs:{id:"use-case-packaging-and-distributing-a-binary"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#use-case-packaging-and-distributing-a-binary","aria-hidden":"true"}},[t._v("#")]),t._v(" Use case: packaging and distributing a binary")]),t._v(" "),e("p",[t._v("To illustrate the log filter functionality, we'll create a project to package and distribute a binary. We'll be using the "),e("a",{attrs:{href:"https://github.com/clofresh/rundeck-playground",target:"_blank",rel:"noopener noreferrer"}},[t._v("Rundeck Playground"),e("OutboundLink")],1),t._v(" environment to simulate a data center locally on your workstation.")]),t._v(" "),e("p",[t._v("A common workflow for distributing binaries is to create an OS package on a builder machine that's optimized for packaging code, upload the built package to a package repository, and then have the destination machines pull the latest version of the package from the repository. In this tutorial, our OS is Ubuntu Linux so we'll be building .deb packages. We'll be using S3 to store the packages. To avoid needing an AWS account when doing the tutorial, we provision a mock S3 server that mirror's S3's API. Lastly, to allow our destination machines to download the package, we'll be passing them a presigned S3 download url which acts as temporary credentials and removes the need for an AWS SDK on the destination machine.")]),t._v(" "),e("p",[t._v("Side note: In a traditional data center, you might just install the AWS CLI tool on the destination host and either authorize that host's IAM role to download from your S3 bucket, or pass a set of AWS credentials from Rundeck's Key Storage to the AWS S3 client at download time. But maybe we have a less common setup, like an IoT deployment of low powered Raspberry Pi's which would struggle to print the help text of the AWS CLI tool.")]),t._v(" "),e("h2",{attrs:{id:"building-the-package"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#building-the-package","aria-hidden":"true"}},[t._v("#")]),t._v(" Building the package")]),t._v(" "),e("p",[t._v("First, we need to create a script to build the package. For convenience, let's say we want to distribute the Hashicorp Consul binary.")]),t._v(" "),e("p",[t._v("First we need to download the binary we want to distribute:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$!")]),t._v("/bin/bash -xe\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Change to a new temporary directory")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp -d"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create the download url")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("consul\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VERSION")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.2.3"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://releases.hashicorp.com/'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME_")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v('_linux_amd64.zip"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Download the url to the current directory")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Downloading '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -sOL "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Unzip the downloaded file. In this case we know it's a single file: the consul binary.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("basename")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n")])])]),e("p",[t._v("Then we need to package the binary into a .deb format. We'll use the very handy "),e("a",{attrs:{href:"https://github.com/jordansissel/fpm",target:"_blank",rel:"noopener noreferrer"}},[t._v("fpm"),e("OutboundLink")],1),t._v(" utility to abstract the gory details into a one-liner:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Call fpm with a directory as the source and a deb as the target. Name the package consul and give it the same version as what we downloaded.")]),t._v("\nfpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v('"')]),t._v(" --version "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("We want the consul binary to be executable in the system's executable path, so we create that directory structure before calling fpm:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PKG_DIR")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("usr\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('/bin"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" ./consul "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('/bin"')]),t._v("\nfpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v('"')]),t._v(" --version "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("The full script so far looks like:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$!")]),t._v("/bin/bash -xe\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Change to a new temporary directory")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp -d"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create the download url")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("consul\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VERSION")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.2.3"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://releases.hashicorp.com/'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME_")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v('_linux_amd64.zip"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Download the url to the current directory")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Downloading '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -sOL "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Unzip the downloaded file. In this case we know")]),t._v("\nit's a single file: the consul binary.\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Packaging '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v(" version "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("basename")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Create the appropriate directory structure")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PKG_DIR")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("usr\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('/bin"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" ./consul "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('/bin"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Call fpm with a directory as the source and a deb as the target. Name the package consul and give it the same version as what we downloaded.")]),t._v("\nfpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v('"')]),t._v(" --version "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v(" --deb-no-default-config-files "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("If you run that you might get:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("+ fpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name consul --version "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v(".3 --deb-no-default-config-files usr\nCreated package "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(":path"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"consul_1.2.3_amd64.deb"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v('"Oh," you might be thinking, "Maybe I should use the Key Value Data log filter to capture that path output to capture that outputed filename to pass to an upload script."')]),t._v(" "),e("p",[t._v("You could do that, especially if you had a custom script plugin to do uploads. However for this tutorial, we'll just do the uploading from the same script, so we'll capture the outputted filename like this:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DEB_FILE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("fpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v('"')]),t._v(" --version "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v(" --deb-no-default-config-files  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PKG_DIR")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ruby -e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'puts eval(STDIN.read)[:path]'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n")])])]),e("p",[t._v("Here we're piping the fpm output into a Ruby snippet to parse the map and print out the path key, which we capture in the DEB_FILE bash variable.")]),t._v(" "),e("p",[t._v("Now we upload the .deb file using the AWS CLI tool and a set of AWS credentials passed into the script:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("S3_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3://rundeck-playground/consul/'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${DEB_FILE}")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Uploading '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v(" to "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_ACCESS_KEY_ID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" +x "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't log the secret key")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_SECRET_ACCESS_KEY")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" -x "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Continue verbose bash logging")]),t._v("\naws s3 "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" --quiet "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("In the Rundeck Playground environment, you don't need to create the bucket beforehand because it's a mock s3 server, but in the real AWS environment, you do.")]),t._v(" "),e("p",[t._v("Lastly, we want to generate a presigned url that we want Rundeck to pass to the destination nodes that will install the package. To do that:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Generating presigned url for '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DOWNLOAD_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("aws s3 presign "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RUNDECK:DATA:DOWNLOAD_URL = '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DOWNLOAD_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RUNDECK:DATA:DEB_FILE = '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("The "),e("code",[t._v("aws s3 presign")]),t._v(" command takes an S3 path that you have access to and creates a url that anyone can read from but expires in a fixed amount of time, in this case the default is 1 hour. It prints out the presigned url which we capture in the DOWNLOAD_URL bash variable.")]),t._v(" "),e("p",[t._v("Now, we print out the variables we want to use in subsequent Rundeck steps in a format that Rundeck can capture: "),e("code",[t._v("RUNDECK:DATA:$VARIABLE = $VALUE")])]),t._v(" "),e("p",[t._v("The full build.sh script:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash -xe")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("S3_BASE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rundeck-playground/consul/\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("mktemp -d"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("_pkgdir")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pkg"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("consul\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("BIN_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${BIN_NAME-$NAME}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("VERSION")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.2.3"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://releases.hashicorp.com/consul/'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v("/consul_"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${VERSION}")]),t._v('_linux_amd64.zip"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_pkgdir")]),t._v('"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Downloading '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -sOL "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Packaging '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v(" version "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("unzip")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("basename")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$URL")]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$BIN_NAME")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${_pkgdir}")]),t._v('/usr/bin"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$BIN_NAME")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${_pkgdir}")]),t._v('/usr/bin"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${_pkgdir}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("DEB_FILE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("fpm -s "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" -t deb --name "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$NAME")]),t._v('"')]),t._v(" --version "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$VERSION")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ruby -e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'puts eval(STDIN.read)[:path]'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("S3_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s3://'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${S3_BASE"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%%")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("*}")]),t._v("/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${DEB_FILE}")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Uploading '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v(" to "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_ACCESS_KEY_ID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" +x\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_SECRET_ACCESS_KEY")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" -x\naws s3 "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" --quiet "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INFO - Generating presigned url for '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" -n "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RUNDECK:DATA:DOWNLOAD_URL = "')]),t._v("\naws s3 presign "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$S3_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RUNDECK:DATA:DEB_FILE = '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DEB_FILE")]),t._v('"')]),t._v("\n")])])]),e("h2",{attrs:{id:"wrap-the-build-script-in-a-custom-script-step-plugin"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#wrap-the-build-script-in-a-custom-script-step-plugin","aria-hidden":"true"}},[t._v("#")]),t._v(" Wrap the build script in a custom script step plugin")]),t._v(" "),e("p",[t._v("To trigger build script we just created, we could use a Rundeck script step. However, since the script needs credentials, it's better practice to wrap the script in a custom script step plugin so that you can securely pass secrets from Key Storage into the script.")]),t._v(" "),e("p",[t._v("The build script's plugin.yaml would look like:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deb builder\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rundeckPluginVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("author")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Carlo Cabanilla\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("date")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token datetime number"}},[t._v("2018-09-21")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//rundeck.org/\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("providers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" BuildDeb\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("service")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RemoteScriptNodeStep\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("plugin-type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" script\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script-interpreter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /bin/bash "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("xe\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script-file")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build.sh\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script-args")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("config.aws_access_key_id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("config.aws_secret_access_key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" aws_access_key_id\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" String\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("renderingOptions")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("valueConversion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"STORAGE_PATH_AUTOMATIC_READ"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" aws_secret_access_key\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" String\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("renderingOptions")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("valueConversion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"STORAGE_PATH_AUTOMATIC_READ"')]),t._v("\n")])])]),e("p",[t._v("Note the "),e("code",[t._v('renderingOptions:valueConversion: "STORAGE_PATH_AUTOMATIC_READ"')]),t._v(" settings on the credential values. That lets us pass in Key Storage paths and the plugin will pull the values and pass it into the script. For a more detailed tutorial on custom script step plugins, see (/tutorials/custom-script-plugin-hello-world.md).")]),t._v(" "),e("h2",{attrs:{id:"create-the-job"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-the-job","aria-hidden":"true"}},[t._v("#")]),t._v(" Create the job")]),t._v(" "),e("p",[t._v("Now we need a job to trigger the script step. It might look like this:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fpm\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" BuildDeb\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeStep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configuration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_access_key_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("id\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_secret_access_key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/secret"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key\n")])])]),e("p",[t._v("The new config here are the Key Storage paths to the AWS credentials and the nodefilter to select the node to run the build.")]),t._v(" "),e("h2",{attrs:{id:"highlighting-high-level-log-output"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#highlighting-high-level-log-output","aria-hidden":"true"}},[t._v("#")]),t._v(" Highlighting high level log output")]),t._v(" "),e("p",[t._v("If we test it out in the web UI, the output might look like:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(367),alt:"Without highlighting"}})]),t._v(" "),e("p",[t._v("Here we can apply our first log filter to call out our high level logging output so that it stands out from the low level script commands.")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fpm\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pluginConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LogFilter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" highlight"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("output\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bgcolor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yellow\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bold\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^INFO\\s*"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("\\s*(.*)$\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" BuildDeb\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeStep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configuration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_access_key_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("id\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_secret_access_key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/secret"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key\n")])])]),e("p",[e("img",{attrs:{src:s(368),alt:"With highlighting"}})]),t._v(" "),e("p",[t._v("Now we can more easily skim the log output for the important steps.")]),t._v(" "),e("h2",{attrs:{id:"prevent-accidental-leakage-of-secrets"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prevent-accidental-leakage-of-secrets","aria-hidden":"true"}},[t._v("#")]),t._v(" Prevent accidental leakage of secrets")]),t._v(" "),e("p",[t._v("Remember this snippet of our build script?")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" +x\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("AWS_SECRET_ACCESS_KEY")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" -x\n")])])]),e("p",[t._v("Since we're running the script with "),e("code",[t._v("bash -x")]),t._v(", it prints out each command that it's running and the values of the variables we assign. The above snippet explictly suppresses that verbose logging when we set the secret key to avoid exposing it in the logs.")]),t._v(" "),e("p",[t._v("What if we didn't have the foresight to supress that output? Could we prevent ourselves from shooting ourselves in the foot?")]),t._v(" "),e("p",[t._v("We can partially protect ourselves using the "),e("code",[t._v("quiet-output")]),t._v(" log filter:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pluginConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LogFilter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" quiet"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("output\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("loglevel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" debug\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLoglevel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" all\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("quietMatch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" AWS_SECRET_ACCESS_KEY\n")])])]),e("p",[t._v("Here we're saying at any log level, if you see the string "),e("code",[t._v("AWS_SECRET_ACCESS_KEY")]),t._v(", change that log line's log level to debug. This would have prevented us leaking the the key from "),e("code",[t._v("bash -x")]),t._v(" output, assuming we were running under the default log level. However, the filter wouldn't hide it if you ran it with the debug log level.")]),t._v(" "),e("p",[t._v("Additionally, it won't prevent something like:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$AWS_SECRET_ACCESS_KEY")]),t._v("\n")])])]),e("p",[t._v("Because "),e("code",[t._v("bash -x")]),t._v(" logging would have evaluated the variable already and it will show up as:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("+ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" whatever_the_value_is\n")])])]),e("p",[t._v("So while the "),e("code",[t._v("quiet-output")]),t._v(" shouldn't be your main protection from hiding secrets, it's another possible safeguard and better than nothing.")]),t._v(" "),e("h2",{attrs:{id:"running-jobs-on-different-sets-of-nodes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#running-jobs-on-different-sets-of-nodes","aria-hidden":"true"}},[t._v("#")]),t._v(" Running jobs on different sets of nodes")]),t._v(" "),e("p",[t._v("We want to install the package on different nodes than we built it on, but there's no way to specify a different set of nodes for different steps, so how can we proceed?")]),t._v(" "),e("p",[t._v("We can create another job to install the package and reference the build job to trigger the build. Here is the new job:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" InstallDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web_.*\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n        #!/bin/bash -xe\n        WORKING_DIR=$(mktemp -d)\n        echo "INFO - Downloading $2 to $WORKING_DIR"\n        cd $WORKING_DIR\n        curl -sL "$1" > $2\n        echo "INFO - Installing $2"\n        dpkg -i "$2"\n        rm "$2"')]),t._v("\n")])])]),e("p",[t._v("The new node filter points to the web nodes, our destination for the package.")]),t._v(" "),e("p",[e("code",[t._v("jobref")]),t._v(" lets us call other jobs and let them use their own node filter. In this case we call PackageDeb to package the deb on the fpm node.")]),t._v(" "),e("p",[t._v("The second step is an inline script to download and install the package. We don't need to wrap it in a custom script step plugin because there's no credentials to deal with.")]),t._v(" "),e("h2",{attrs:{id:"passing-data-from-one-job-to-another"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#passing-data-from-one-job-to-another","aria-hidden":"true"}},[t._v("#")]),t._v(" Passing data from one job to another")]),t._v(" "),e("p",[t._v("But wait, how does this job know what the download url and the name of the package file are? At last, this is where the key value log filter comes into play:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" InstallDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web_.*\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pluginConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LogFilter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("logData")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'false'")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^RUNDECK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("DATA"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("(.+"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")]),t._v(")\\s*=\\s*(.+)$\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("data.DOWNLOAD_URL"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("data.DEB_FILE"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n        #!/bin/bash -xe\n        WORKING_DIR=$(mktemp -d)\n        echo "INFO - Downloading $2 to $WORKING_DIR"\n        cd $WORKING_DIR\n        curl -sL "$1" > $2\n        echo "INFO - Installing $2"\n        dpkg -i "$2"\n        rm "$2"')]),t._v("\n")])])]),e("p",[t._v("Here we define a regex to capture that simple format we used in the build script. The variables get stored in the "),e("code",[t._v("data")]),t._v(" context where we can refer to them later on in the job.")]),t._v(" "),e("p",[t._v("However! If the InstallDeb's own log output printed out "),e("code",[t._v("RUNDECK:DATA:DOWNLOAD_URL = ...")]),t._v(" then this would work, but the above configuration won't work because the parent job doesn't have access to the job reference's data.")]),t._v(" "),e("p",[t._v("Instead, we need to export the variables from the build job so that the install job has access to them. Modifying the PackageDeb job:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fpm\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pluginConfig")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LogFilter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("logData")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("regex")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ^RUNDECK"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("DATA"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("(.+"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")]),t._v(")\\s*=\\s*(.+)$\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" BuildDeb\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeStep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configuration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_access_key_id")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("id\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("aws_secret_access_key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keys/projects/hello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("project/aws/secret"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("access"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("key\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" export"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("var\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeStep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configuration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("export")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DOWNLOAD_URL\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" export\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("data.DOWNLOAD_URL@fpm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" export"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("var\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeStep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configuration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("export")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DEB_FILE\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" export\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("data.DEB_FILE@fpm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("The key here is the "),e("code",[t._v("export-var")]),t._v(" steps to move the "),e("code",[t._v("data.DOWNLOAD_URL")]),t._v(" and "),e("code",[t._v("data.DEB_FILE")]),t._v(" values captured with the "),e("code",[t._v("key-value-data")]),t._v(" log filter into the "),e("code",[t._v("export")]),t._v(" global variable group.")]),t._v(" "),e("p",[t._v("Now our InstallDeb job can use those global variables:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" InstallDeb\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefilters")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web_.*\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sequence")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uuid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PackageDeb\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("args")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("export.DOWNLOAD_URL"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("export.DEB_FILE"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n        #!/bin/bash -xe\n        WORKING_DIR=$(mktemp -d)\n        echo "INFO - Downloading $2 to $WORKING_DIR"\n        cd $WORKING_DIR\n        curl -sL "$1" > $2\n        echo "INFO - Installing $2"\n        dpkg -i "$2"\n        rm "$2"')]),t._v("\n")])])]),e("p",[t._v("And now the web nodes have the presigned url generated by the fpm node. Magic!")]),t._v(" "),e("p",[t._v("To recap, running this job would:")]),t._v(" "),e("ul",[e("li",[t._v("Run a script on a build node to package a binary into a deb and securely upload it to S3.")]),t._v(" "),e("li",[t._v("Pass a temporary url from the build node to let a different set of nodes without AWS credentials or a special S3 client download and install the package.")])])])},[],!1,null,null,null);a.default=n.exports}}]);